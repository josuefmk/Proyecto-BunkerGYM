{% extends 'core/home.html' %}
{% load static %}

{% block content %}
<main class="registro-wrapper">

    {% if mensaje %}
    <div class="alert-success fade-in">
        {{ mensaje }}
    </div>
    <script>
        setTimeout(() => {
            const msg = document.querySelector(".alert-success");
            if (msg) msg.style.opacity = "0";
        }, 4000);
    </script>
    {% endif %}

    <div class="registro-card">
        <h2>Registrar Nuevo Cliente</h2>
        <p class="sub">Complete la informaciÃ³n requerida</p>

        <form method="POST" class="registro-form" onsubmit="return validarFormulario()">
            {% csrf_token %}

            {% for field in form %}
                {% if field.name == "sub_plan" or field.name == "coach_asignado" %}
                    {{ field }}
                {% else %}
                <div class="input-group-registro">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“Œ</span>
                        {{ field }}
                    </div>

                    {% for error in field.errors %}
                        <p class="error-msg">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            {% endfor %}

            <button class="btn-premium-registro">Crear Cliente</button>
            <a href="{% url 'index' %}"  class="btn-premium-secundario">âŸµ Volver</a>
        </form>
    </div>

</main>

<!-- MODAL SUBPLAN -->
<div id="modalSubPlan" class="modal-premium" style="display:none;">
    <div class="modal-content-premium">
        <h3>Seleccione un SubPlan</h3>
        <label><input type="radio" name="subPlanOption" value="Bronce"> ðŸ¥‰ Bronce (4 Accesos)</label><br>
        <label><input type="radio" name="subPlanOption" value="Hierro"> ðŸª™ Hierro (8 Accesos)</label><br>
        <label><input type="radio" name="subPlanOption" value="Acero"> ðŸ›¡ Acero (12 Accesos)</label><br>
        <label><input type="radio" name="subPlanOption" value="Titanio"> âš” Titanio (Acceso Libre)</label>

        <button onclick="guardarSubPlan()" class="btn-premium-registro modal-btn">Aceptar</button>
    </div>
</div>

<!-- MODAL COACH -->
<div id="modalCoach" class="modal-premium" style="display:none;">
    <div class="modal-content-premium">
        <h3>Seleccione un Coach</h3>

        <select id="coachSelect" class="select-premium">
            <option value="">-- Selecciona un Coach --</option>
            {% for coach in coaches %}
            <option value="{{ coach.id }}">{{ coach.nombre }} {{ coach.apellido }} ({{ coach.profesion }})</option>
            {% endfor %}
        </select>

        <button onclick="guardarCoach()" class="btn-premium-registro modal-btn">Aceptar</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



<script>
$(document).ready(function() {
    // Inicializa Select2
    $('#id_planes_personalizados').select2({
        placeholder: "Selecciona hasta 2 planes personalizados",
        maximumSelectionLength: 2,
        allowClear: true,
        width: '100%'
    });

    // Variable para controlar si ya mostramos modal coach
    let modalCoachMostrado = false;

    // FunciÃ³n para mostrar u ocultar modal coach segÃºn selecciÃ³n
    function toggleModalCoach() {
        const seleccionados = $('#id_planes_personalizados').val();
        if (seleccionados && seleccionados.length > 0 && !modalCoachMostrado) {
            $("#modalCoach").css("display", "flex");
            modalCoachMostrado = true;
        } else if (!seleccionados || seleccionados.length === 0) {
            $("#modalCoach").css("display", "none");
            modalCoachMostrado = false;
        }
    }

    // Verificar estado inicial del select personalizado al cargar pÃ¡gina
    toggleModalCoach();

    // Escuchar cambios en planes personalizados
    $('#id_planes_personalizados').on('change', function() {
        toggleModalCoach();
    });

    // Modal Sub Plan
    const selectPlan = document.getElementById("id_mensualidad");
    if (selectPlan) {
        selectPlan.addEventListener("change", function() {
            const selectedText = this.options[this.selectedIndex].text.trim().toLowerCase();
            const excepciones = ["pase diario", "plan diario", "pase diario + plan diario"];

            if (excepciones.includes(selectedText)) {
                document.getElementById("id_sub_plan").value = "";
                document.getElementById("modalSubPlan").style.display = "none";
            } else if (this.value) {
                document.getElementById("modalSubPlan").style.display = "flex";
            }
        });
    }

    // FunciÃ³n guardar Sub Plan
    window.guardarSubPlan = function() {
        const elegido = document.querySelector('input[name="subPlanOption"]:checked');
        if (!elegido) {
            alert("Selecciona un sub plan");
            return;
        }
        document.getElementById("id_sub_plan").value = elegido.value;
        document.getElementById("modalSubPlan").style.display = "none";
    }

    // FunciÃ³n guardar Coach
    window.guardarCoach = function() {
        const elegido = document.getElementById('coachSelect').value;
        if (!elegido) {
            alert("Selecciona un coach antes de continuar");
            return;
        }
        document.getElementById('id_coach_asignado').value = elegido;
        document.getElementById("modalCoach").style.display = "none";
    }

    // Cierre de modales al hacer clic fuera
    window.onclick = function(event) {
        const modalSubPlan = document.getElementById("modalSubPlan");
        const modalCoach = document.getElementById("modalCoach");

        if (event.target === modalSubPlan) {
            modalSubPlan.style.display = "none";
        }
        if (event.target === modalCoach) {
            modalCoach.style.display = "none";
        }
    }

    // ValidaciÃ³n formulario
    window.validarFormulario = function() {
        document.querySelectorAll('.form-group').forEach(div => {
            div.querySelector('.error-text').textContent = '';
            const input = div.querySelector('input, select, textarea');
            if (input) input.style.borderColor = '';
        });

        let valido = true;

        const camposObligatorios = [
            {id: "id_nombre", label: "Nombres"},
            {id: "id_apellido", label: "Apellidos"},
            {id: "id_correo", label: "Email"},
            {id: "id_telefono", label: "TelÃ©fono"},
            {id: "id_rut", label: "RUT"},
            {id: "id_mensualidad", label: "Plan"},
            {id: "id_metodo_pago", label: "MÃ©todo de pago"}
        ];

        camposObligatorios.forEach(campoInfo => {
            const campo = document.getElementById(campoInfo.id);
            if (campo && !campo.value.trim()) {
                const group = campo.closest('.form-group');
                if (group) {
                    const errorDiv = group.querySelector('.error-text');
                    errorDiv.textContent = `El campo "${campoInfo.label}" es obligatorio.`;
                    campo.style.borderColor = 'red';
                }
                valido = false;
            }
        });

        const mensualidad = document.getElementById("id_mensualidad");
        const subPlan = document.getElementById("id_sub_plan");

        if (mensualidad && mensualidad.value) {
            const selectedText = mensualidad.options[mensualidad.selectedIndex].text.trim().toLowerCase();
            const excepciones = ["pase diario", "plan diario", "pase diario + plan diario"];
            if (!excepciones.includes(selectedText) && (!subPlan || !subPlan.value)) {
                const group = mensualidad.closest('.form-group');
                if (group) {
                    const errorDiv = group.querySelector('.error-text');
                    errorDiv.textContent = "Debes seleccionar un sub plan.";
                    mensualidad.style.borderColor = 'red';
                }
                valido = false;
            }
        }

        return valido;
    }
});

</script>


{% endblock %}
