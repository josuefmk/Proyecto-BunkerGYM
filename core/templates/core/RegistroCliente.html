{% extends 'core/home.html' %}
{% load static %}

{% block content %}



<main class="registro-wrapper">

    <div class="registro-card">

        {% if mensaje %}
        <div class="alert-success fade-in">
            âœ“ {{ mensaje }}
        </div>

        <script>
            setTimeout(() => {
                const msg = document.querySelector(".alert-success");
                if (msg) msg.style.opacity = "0";
            }, 4000);
        </script>
        {% endif %}

        <h2>Registrar Nuevo Cliente</h2>
        <p class="sub">Complete la informaciÃ³n requerida</p>

        <form method="POST" class="registro-form" onsubmit="return validarFormulario()">
            {% csrf_token %}

            {% for field in form %}
                {% if field.name == "sub_plan" or field.name == "coach_asignado" %}
                    {{ field }}
                {% else %}
                <div class="input-group-registro">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    <div class="input-wrapper">
                        <span class="input-icon">ðŸ“Œ</span>
                        {{ field }}
                    </div>

                    {% for error in field.errors %}
                        <p class="error-msg">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            {% endfor %}

            <button class="btn-premium-registro">Crear Cliente</button>
            <br><br>
            <a href="{% url 'index' %}" class="btn-premium-secundario">âŸµ Volver</a>
        </form>
    </div>

</main>


<!-- ============== MODAL SUB PLAN ============== -->
<div id="modalSubPlan" class="modal-premium">
    <div class="modal-content-premium">
        <h3>Seleccione un SubPlan</h3>
        <label><input type="radio" name="subPlanOption" value="Bronce"> ðŸ¥‰ Bronce (4 Accesos)</label>
        <label><input type="radio" name="subPlanOption" value="Hierro"> ðŸª™ Hierro (8 Accesos)</label>
        <label><input type="radio" name="subPlanOption" value="Acero"> ðŸ›¡ Acero (12 Accesos)</label>
        <label><input type="radio" name="subPlanOption" value="Titanio"> âš” Titanio (Acceso Libre)</label>

        <button onclick="guardarSubPlan()" class="modal-btn">Aceptar</button>
    </div>
</div>

<!-- ============== MODAL COACH ============== -->
<div id="modalCoach" class="modal-premium">
    <div class="modal-content-premium">
        <h3>Seleccione un Coach</h3>

        <select id="coachSelect" class="select-premium">
            <option value="">-- Selecciona un Coach --</option>
            {% for coach in coaches %}
            <option value="{{ coach.id }}">{{ coach.nombre }} {{ coach.apellido }} ({{ coach.profesion }})</option>
            {% endfor %}
        </select>

        <button onclick="guardarCoach()" class="modal-btn">Aceptar</button>
    </div>
</div>


<!-- SELECT2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<script>
$(document).ready(function() {

    // Inicializar Select2
    $('#id_planes_personalizados').select2({
        placeholder: "Selecciona hasta 2 planes personalizados",
        maximumSelectionLength: 2,
        allowClear: true,
        width: '100%'
    });


    let modalCoachMostrado = false;

    function toggleModalCoach() {
        const seleccionados = $('#id_planes_personalizados').val();
        if (seleccionados && seleccionados.length > 0 && !modalCoachMostrado) {
            $("#modalCoach").fadeIn().css("display", "flex");
            modalCoachMostrado = true;
        } else if (!seleccionados || seleccionados.length === 0) {
            $("#modalCoach").fadeOut();
            modalCoachMostrado = false;
        }
    }

    toggleModalCoach();

    $('#id_planes_personalizados').on('change', () => toggleModalCoach());

    window.guardarCoach = function() {
        const coach = document.getElementById('coachSelect').value;
        if (!coach) {
            alert("Selecciona un coach");
            return;
        }
        document.getElementById("id_coach_asignado").value = coach;
        $("#modalCoach").fadeOut();
    };


    const selectPlan = document.getElementById("id_mensualidad");

    if (selectPlan) {
        selectPlan.addEventListener("change", function() {
            const texto = this.options[this.selectedIndex].text.toLowerCase();
            const excepciones = ["pase diario", "plan diario", "pase diario + plan diario"];

            if (!excepciones.includes(texto) && this.value) {
                $("#modalSubPlan").fadeIn().css("display", "flex");
            } else {
                $("#modalSubPlan").fadeOut();
            }
        });
    }

    window.guardarSubPlan = function() {
        const elegido = document.querySelector('input[name="subPlanOption"]:checked');
        if (!elegido) {
            alert("Selecciona un sub plan");
            return;
        }
        document.getElementById("id_sub_plan").value = elegido.value;
        $("#modalSubPlan").fadeOut();
    };

    /* Cerrar modales al hacer clic fuera */
    window.onclick = function(e) {
        if (e.target.classList.contains("modal-premium")) {
            e.target.style.display = "none";
        }
    };

    /* Cerrar con ESC */
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
            $("#modalSubPlan").fadeOut();
            $("#modalCoach").fadeOut();
        }
    });
});
</script>

{% endblock %}
