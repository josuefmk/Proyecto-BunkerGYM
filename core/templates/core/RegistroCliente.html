{% extends 'core/home.html' %}
{% load static %}

{% block content %}
<main class="contenido">

    {% if mensaje %}
    <div id="mensaje-exito-registro" style="
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
    ">
        {{ mensaje }}
    </div>
    <script>
    setTimeout(function() {
        var mensajeDiv = document.getElementById('mensaje-exito-registro');
        if (mensajeDiv) {
            mensajeDiv.style.display = 'none';
        }
    }, 5000);
    </script>
    {% endif %}

    <div class="form-container">
        <form class="formulario" method="POST" onsubmit="return validarFormulario()" novalidate>
            {% csrf_token %}
            <h2>CreaciÃ³n De Cliente</h2>

            {% for field in form %}
                {% if field.name != 'sub_plan' %}
                    <div class="mb-3 form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}:</label>
                        {{ field }}
                        <div class="error-text" style="color: red; font-size: 0.9em;"></div>
                        {% for error in field.errors %}
                            <p class="error">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ field }}
                {% endif %}
            {% endfor %}

            <button type="submit" class="btn-global" style="margin-top: 15px;">âœ… Crear Cliente</button>
            <a href="{% url 'index' %}" class="btn-global" style="margin-top: 15px;">ðŸ”™ Volver</a>
        </form>
    </div>

    <!-- Modal para seleccionar Sub Plan -->
    <div id="modalSubPlan" class="modal-custom" style="display:none;">
        <div class="modal-content-custom">
            <label><input type="radio" name="subPlanOption" value="Bronce"> ðŸ¥‰ Bronce (4 Accesos)</label><br>
            <label><input type="radio" name="subPlanOption" value="Hierro"> ðŸª™ Hierro (8 Accesos)</label><br>
            <label><input type="radio" name="subPlanOption" value="Acero"> ðŸ›¡ Acero (12 Accesos)</label><br>
            <label><input type="radio" name="subPlanOption" value="Titanio"> âš” Titanio (Acceso Libre)</label><br>
            <div style="margin-top: 15px;">
                <button type="button" onclick="guardarSubPlan()" class="btn-global modal-content-customv2">Aceptar</button>
            </div>
        </div>
    </div>

</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    $('#id_planes_personalizados').select2({
        placeholder: "Selecciona hasta 2 planes personalizados",
        maximumSelectionLength: 2,
        allowClear: true,
        width: '100%'
    });
  });

  document.addEventListener("DOMContentLoaded", function() {
      const selectPlan = document.getElementById("id_mensualidad");
      if (selectPlan) {
          selectPlan.addEventListener("change", function() {
              if (this.value) {
                  document.getElementById("modalSubPlan").style.display = "flex";
              }
          });
      }
  });

  function guardarSubPlan() {
      let elegido = document.querySelector('input[name="subPlanOption"]:checked');
      if (!elegido) {
          alert("Selecciona un sub plan");
          return;
      }
      document.getElementById("id_sub_plan").value = elegido.value;
      document.getElementById("modalSubPlan").style.display = "none";
  }

  window.onclick = (event) => {
      const modal = document.getElementById("modalSubPlan");
      if(event.target === modal) {
          modal.style.display = "none";
      }
  };


  function validarFormulario() {
 
      document.querySelectorAll('.form-group').forEach(div => {
          div.querySelector('.error-text').textContent = '';
          const input = div.querySelector('input, select, textarea');
          if (input) input.style.borderColor = '';
      });

      let valido = true;
      const camposObligatorios = [
          {id: "id_nombre", label: "Nombres"},
          {id: "id_apellido", label: "Apellidos"},
          {id: "id_correo", label: "Email"},
          {id: "id_telefono", label: "TelÃ©fono"},
          {id: "id_rut", label: "RUT"},
          {id: "id_mensualidad", label: "Plan"},
          {id: "id_metodo_pago", label: "MÃ©todo de pago"}
      ];

      camposObligatorios.forEach(campoInfo => {
          const campo = document.getElementById(campoInfo.id);
          if (campo && !campo.value.trim()) {
              const group = campo.closest('.form-group');
              if (group) {
                  const errorDiv = group.querySelector('.error-text');
                  errorDiv.textContent = `El campo "${campoInfo.label}" es obligatorio.`;
                  campo.style.borderColor = 'red';
              }
              valido = false;
          }
      });

      const mensualidad = document.getElementById("id_mensualidad");
      const subPlan = document.getElementById("id_sub_plan");
      if (mensualidad && mensualidad.value && (!subPlan || !subPlan.value)) {
          const group = mensualidad.closest('.form-group');
          if (group) {
              const errorDiv = group.querySelector('.error-text');
              errorDiv.textContent = "Debes seleccionar un sub plan.";
              mensualidad.style.borderColor = 'red';
          }
          valido = false;
      }

      return valido;
  }
</script>
{% endblock %}
