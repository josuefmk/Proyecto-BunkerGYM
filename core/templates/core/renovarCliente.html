{% extends 'core/home.html' %}
{% load static %}

{% block content %}
<div class="centrar-buscador">
    <form method="get" class="busqueda-container">
        <div class="busqueda-fila">
            <input
                type="text"
                id="rutInput"
                name="rut"
                placeholder="Buscar cliente por RUT, nombre o apellido"
                value="{{ rut_buscado }}"
            >
            <button type="submit" class="btn-global">üîç Buscar</button>
        </div>

        {% if rut_buscado %}
            <div class="mostrar-todos">
                <a href="{% url 'renovarCliente' %}" class="btn-global">
                    üßπ Limpiar Filtro
                </a>
            </div>
        {% endif %}

        <div id="errorMensaje" class="error-text"></div>
    </form>
</div>


{% if messages %}
  <div id="mi-mensaje-contenedor" class="mi-mensaje-contenedor">
    {% for message in messages %}
      <div class="mi-mensaje mi-mensaje-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>

  <script>
    setTimeout(function() {
      const mensaje = document.getElementById("mi-mensaje-contenedor");
      if (mensaje) {
        mensaje.style.transition = "opacity 1s ease";
        mensaje.style.opacity = 0;
        setTimeout(() => mensaje.remove(), 8000); 
      }
    }, 8000); 
  </script>
{% endif %}

{% if clientes %}
<div class="tabla-responsive">
    <table class="tabla-renovar">
        <thead>
            <tr>
                <th>Nombre Completo</th>
                <th>RUT</th>
                <th>Tipo de Planes</th>
                <th>Sub Planes</th>
                <th>Planes Personalizados</th>
                <th>Estado De Plan</th>
                <th>M√©todo de pago</th>
                <th>Renovar</th>
                <th>Modificar Cliente</th>
                <th>Eliminar Cliente</th>
            </tr>
        </thead>
      <tbody>
    {% for cliente in clientes %}
    <tr>
        <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
        <td>{{ cliente.rut }}</td>

        <!-- Tipo de plan -->
        <td>
            <select name="nuevo_plan" id="plan-{{ cliente.rut }}" class="select-bonito">
                <option value="">-- Selecciona Mensualidad --</option>
                {% for mensualidad in tipos_mensualidad %}
                    <option value="{{ mensualidad.id }}" {% if cliente.mensualidad and cliente.mensualidad.id == mensualidad.id %}selected{% endif %}>
                        {{ mensualidad.tipo }} + Plan {{ mensualidad.duracion }}
                    </option>
                {% endfor %}
            </select>
        </td>

        <!-- SubPlan -->
        <td>
            <select name="nuevo_sub_plan" id="subplan-{{ cliente.rut }}" class="select-bonito" onchange="confirmarCambioSubplan('{{ cliente.rut }}')">
                <option value="">-- Selecciona SubPlan --</option>
                {% for key, value in cliente.SUB_PLANES %}
                    <option value="{{ key }}" {% if cliente.sub_plan == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
            </select>
        </td>

     
       <!-- Plan personalizado -->
            <td style="vertical-align: middle; text-align: left;">
                <form method="post" action="{% url 'cambiar_planes_personalizados' %}" id="form-plan-personalizado-{{ cliente.rut }}" style="margin: 0;">
                    {% csrf_token %}
                    <input type="hidden" name="rut_cliente" value="{{ cliente.rut }}">
                    <select name="nuevo_planes_personalizados" class="select2 select-plan-personalizado" multiple="multiple" data-rut="{{ cliente.rut }}" style="width: 180px;">
                        {% for plan in planes_personalizados %}
                            <option value="{{ plan.id }}" {% if plan in cliente.planes_personalizados.all %}selected{% endif %}>{{ plan.nombre_plan }}</option>
                        {% endfor %}
                    </select>
                </form>

                {% if cliente.planes_personalizados.exists %}
                    <form method="post" action="{% url 'renovar_plan_personalizado' %}" id="form-renovar-personalizado-{{ cliente.rut }}" style="margin-top: 4px;">
                        {% csrf_token %}
                        <input type="hidden" name="rut_cliente" value="{{ cliente.rut }}">
                        <button type="button" 
                                class="btn-renovar-linea"
                                onclick="abrirModalRenovarPersonalizado('{{ cliente.rut }}')">
                            üîÑ Renovar Plan Personalizado
                        </button>
                    </form>
                {% endif %}
            </td>
            <!-- Estado del plan -->
        <td>
            {% if cliente.estado_plan == 'pendiente' %}
                <span style="color: #0d6efd; font-weight: bold;">
                    Pendiente (Plan comienza el {{ cliente.fecha_inicio_plan|date:"d \d\e F \d\e Y" }})
                </span>
            {% elif cliente.estado_plan == 'vencido' or cliente.estado_plan == 'inactivo' %}
                <span style="color: #dc3545; font-weight: bold;">
                    Inactivo / Vencido
                </span>
            {% else %}
                <span style="color: #198754; font-weight: bold;">
                    Activo ({{ cliente.dias_restantes }} d√≠as)
                </span>
            {% endif %}
        </td>
        <!-- M√©todo de pago -->
        <td>{{ cliente.metodo_pago }}</td>


    
        <!-- Bot√≥n renovar -->
        <td>
            <button type="button" class="btn-global" onclick="confirmarRenovacion('{{ cliente.rut }}')">Renovar</button>
        </td>

        <!-- Bot√≥n editar cliente -->
        <td>
            <button type="button" class="btn-global" onclick="window.location.href='{% url 'modificar_cliente' cliente.id %}'">Editar</button>
        </td>

        <!-- Bot√≥n eliminar cliente -->
        <td>
            <button type="button" class="btn-global" onclick="abrirModalCliente({{ cliente.id }}, '{{ cliente.nombre }} {{ cliente.apellido }}')">Eliminar</button>
        </td>
    </tr>
    {% endfor %}
    </tbody>
        </table>
        </div>

     {% if clientes.has_other_pages %}
    <div class="pagination">
        {% if clientes.has_previous %}
            <a href="?page=1{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}" class="page-btn">‚èÆ Primero</a>
            <a href="?page={{ clientes.previous_page_number }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}" class="page-btn">‚¨Ö Anterior</a>
        {% endif %}

        <span class="page-info">P√°gina {{ clientes.number }} de {{ clientes.paginator.num_pages }}</span>

        {% if clientes.has_next %}
            <a href="?page={{ clientes.next_page_number }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}" class="page-btn">Siguiente ‚û°</a>
            <a href="?page={{ clientes.paginator.num_pages }}{% if rut_buscado %}&rut={{ rut_buscado }}{% endif %}" class="page-btn">√öltimo ‚è≠</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
        <p style="text-align: center; font-size: 18px; color: black;">
            No se encontr√≥ el RUT del Cliente.
        </p>
    {% endif %}
<!-- MODAL PARA LA FECHA DE SESIONES -->
    <div id="modal-sesion" class="modal-renovar" style="display:none;">
    <div class="modal-content-renovar">
        <h2>Registrar Sesi√≥n</h2>
        <p id="texto-modal-sesion"></p>
        <form id="form-modal-sesion" onsubmit="guardarSesion(event)">
            <input type="hidden" id="modal-rut">
            <input type="hidden" id="modal-tipo-sesion">

            <label for="modal-fecha">Selecciona la fecha:</label>
            <input type="date" id="modal-fecha" required>

            <div class="modal-cliente-actions" style="margin-top:10px;">
                <button type="submit" class="btn-global">Guardar</button>
                <button type="button" class="btn-cliente-cancelar" onclick="cerrarModalSesion()">Cancelar</button>
            </div>
        </form>
    </div>
    </div>
<!-- MODAL RENOVAR PLAN PERSONALIZADO -->
<div id="modal-renovar-personalizado" class="modal-renovar" style="display:none;">
    <div class="modal-content-renovar">
        <h2>Confirmar renovaci√≥n</h2>
        <p id="mensaje-renovar-personalizado"></p>
        <div class="modal-cliente-actions">
            <button type="button" class="btn-global" onclick="confirmarRenovacionPersonalizado()">‚úÖ S√≠, renovar</button>
            <button type="button" class="btn-cliente-cancelar" onclick="cerrarModalRenovarPersonalizado()">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL PARA ELIMINAR CLIENTE -->
    <div id="modalEliminarCliente" class="modal modal-error" style="display: none;">
    <div class="modal-cliente-content">
        <button type="button" class="modal-close" onclick="cerrarModalCliente()">&times;</button>
        <h2>Eliminar cliente</h2>
        <p id="mensaje-modal-cliente">¬øEst√°s seguro que deseas eliminar a este cliente?</p>
        <form id="formEliminarCliente" method="POST">
        {% csrf_token %}
        <div class="modal-cliente-actions">
            <button type="submit" class="btn-cliente-eliminar">üóëÔ∏è S√≠, eliminar</button>
            <button type="button" onclick="cerrarModalCliente()" class="btn-cliente-cancelar">Cancelar</button>
        </div>
        </form>
    </div>
    </div>

    <!-- MODAL PARA ELIMINAR PLAN PERSONALIZADO -->
    <div id="modal-eliminar-plan" class="modal-renovar" style="display: none;">
    <div class="modal-content-renovar">
        <h2>Eliminar Plan Personalizado</h2>
        <p id="mensaje-eliminar-plan"></p>
        <div class="modal-cliente-actions">
        <button type="button" class="btn-global" onclick="confirmarEliminarPlan()">üóëÔ∏è S√≠, eliminar</button>
        <button type="button" class="btn-cliente-cancelar" onclick="cerrarModalEliminarPlan()">Cancelar</button>
        </div>
    </div>
    </div>
<!-- MODAL DE CONFIRMACI√ìN DE CAMBIO DE PLAN PERSONALIZADO -->
<div id="modal-cambio-plan" class="modal-renovar" style="display: none;">
  <div class="modal-content-renovar">
    <h2>Confirmar cambio de Plan Personalizado</h2>
    <p id="mensaje-cambio-plan"></p>
    <div class="modal-cliente-actions">
      <button type="button" class="btn-global" onclick="confirmarEnvioCambio()">‚úÖ S√≠, cambiar</button>
      <button type="button" class="btn-cliente-cancelar" onclick="cerrarModalCambio()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL PARA ELEGIR M√âTODO DE PAGO -->
    <div id="modal-metodo-pago" class="modal-renovar" style="display: none;">
        <div class="modal-content-renovar">
            <p>Selecciona el m√©todo de pago:</p>
            <form id="form-metodo-pago" onsubmit="mostrarConfirmacion(event)">
                <input type="hidden" id="rut-metodo" name="rut">
                <select id="metodo-pago" class="select-bonito" required>
                    <option value="">-- Selecciona --</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Debito">D√©bito</option>
                    <option value="Credito">Cr√©dito</option>
                    <option value="Transferencia">Transferencia</option>
                </select>
                <br><br>
                <button type="submit">Continuar</button>
                <button type="button" onclick="cerrarModalMetodo()">Cancelar</button>
            </form>
        </div>
    </div>

<!-- MODAL DE CONFIRMACI√ìN DE RENOVACI√ìN -->
    <div id="modal-confirmar" class="modal-renovar" style="display: none;">
        <div class="modal-content-renovar">
            <p>¬øEst√°s seguro que deseas renovar el plan?</p>
            <form method="post" action="{% url 'renovarCliente' %}">
                {% csrf_token %}
                <input type="hidden" id="rut-renovar" name="renovar_rut">
                <input type="hidden" id="metodo-pago-hidden" name="metodo_pago">
                <input type="hidden" id="nuevo-plan-hidden" name="nuevo_plan">
                <input type="hidden" id="nuevo-subplan-hidden" name="nuevo_sub_plan">
                <button type="submit" onclick="this.disabled=true; this.innerText='Procesando...'; this.form.submit();">
                ‚úÖ S√≠, renovar
                </button>
                <button type="button" onclick="cerrarModal()">Cancelar</button>
            </form>
        </div>
    </div>
<!-- MODAL DE CONFIRMACI√ìN DE CAMBIO DE SUBPLAN -->
    <div id="modal-cambio-subplan" class="modal-renovar" style="display: none;">
        <div class="modal-content-renovar">
            <h2>Confirmar cambio de SubPlan</h2>
            <p id="mensaje-cambio-subplan"></p>
        <form id="form-cambio-subplan" method="post" action="{% url 'cambiar_sub_plan' %}">
        {% csrf_token %}
        <input type="hidden" name="rut_cliente" id="rut-subplan-hidden">
        <input type="hidden" name="nuevo_sub_plan" id="nuevo-subplan-hidden-modal">
        <div class="modal-cliente-actions">
            <button type="submit" class="btn-global">‚úÖ S√≠, cambiar</button>
            <button type="button" onclick="cerrarModalSubplan()" class="btn-cliente-cancelar">Cancelar</button>
        </div>
    </form>
        </div>
    </div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Inicializar Select2 en todos los select de planes personalizados
    $('.select2').select2({
        placeholder: "Selecciona hasta 2 planes personalizados",
        maximumSelectionLength: 2,
        allowClear: true,
        width: '100%'  
    });

    let modalMostrado = false;
    window.formularioTemporal = null;


    $('.select-plan-personalizado').on('change', function () {
        if (modalMostrado) return;

        const form = $(this).closest('form')[0];
        const nombres = $(this).find("option:selected").map(function(){ 
            return $(this).text(); 
        }).get();

        if (nombres.length > 0) {
            const texto = (nombres.length === 1)
                ? `¬øConfirma que desea asignar el plan: "${nombres[0]}"?`
                : `¬øConfirma que desea asignar los planes: "${nombres.join(', ')}"?`;

            document.getElementById("mensaje-cambio-plan").innerText = texto;

            formularioTemporal = form;
            document.getElementById("modal-cambio-plan").style.display = 'flex';

            modalMostrado = true;
        }
    });

    window.confirmarEnvioCambio = function() {
        if (formularioTemporal) formularioTemporal.submit();
        cerrarModalCambio();
        modalMostrado = false;
    }

    window.cerrarModalCambio = function() {
        document.getElementById("modal-cambio-plan").style.display = 'none';
        formularioTemporal = null;
        modalMostrado = false;
    }

  
    let planAEliminar = null;
    let formPlanPersonalizado = null;

    $('.select-plan-personalizado').on('select2:unselecting', function(e) {
        e.preventDefault(); 

        const option = e.params.args.data;
        const nombrePlan = option.text;
        const select = $(this);
        formPlanPersonalizado = select.closest('form')[0];
        planAEliminar = option.id;

        document.getElementById("mensaje-eliminar-plan").innerText =
            `¬øEst√°s seguro que deseas eliminar el plan personalizado: "${nombrePlan}"?`;

        document.getElementById("modal-eliminar-plan").style.display = 'flex';
    });

    window.confirmarEliminarPlan = function() {
        if (formPlanPersonalizado && planAEliminar) {
            const select2Instance = $(formPlanPersonalizado).find('.select-plan-personalizado');
            const values = select2Instance.val() || [];
            const newValues = values.filter(val => val !== planAEliminar);
            select2Instance.val(newValues).trigger('change');

            formPlanPersonalizado.submit();
        }
        cerrarModalEliminarPlan();
    }

    window.cerrarModalEliminarPlan = function() {
        document.getElementById("modal-eliminar-plan").style.display = 'none';
        planAEliminar = null;
        formPlanPersonalizado = null;
    }
});


let formularioTemporal = null;

function confirmarCambioPlan(selectElement, planAnterior) {
    const nuevoTexto = selectElement.options[selectElement.selectedIndex].text;

    if (!nuevoTexto || nuevoTexto.startsWith("--")) return;

    formularioTemporal = selectElement.form;
    document.getElementById("mensaje-cambio-plan").innerText =
        `¬øConfirma que desea cambiar de "${planAnterior || 'Ninguno'}" a "${nuevoTexto}"?`;

    document.getElementById("modal-cambio-plan").style.display = 'flex';
}

function confirmarEnvioCambio() {
    if (formularioTemporal) formularioTemporal.submit();
    cerrarModalCambio();
}

function cerrarModalCambio() {
    document.getElementById("modal-cambio-plan").style.display = 'none';
    formularioTemporal = null;
}

function confirmarRenovacion(rut) {
    document.getElementById('rut-metodo').value = rut;
    document.getElementById('modal-metodo-pago').style.display = 'flex';
}

function cerrarModalMetodo() {
    document.getElementById('modal-metodo-pago').style.display = 'none';
}

function mostrarConfirmacion(event) {
    event.preventDefault();
    const metodo = document.getElementById('metodo-pago').value;
    const rut = document.getElementById('rut-metodo').value;

    if (!metodo) {
        alert("Selecciona un m√©todo de pago");
        return;
    }

    document.getElementById('rut-renovar').value = rut;
    document.getElementById('metodo-pago-hidden').value = metodo;
    document.getElementById('nuevo-plan-hidden').value = document.getElementById(`plan-${rut}`).value;
    document.getElementById('nuevo-subplan-hidden').value = document.getElementById(`subplan-${rut}`).value;

    cerrarModalMetodo();
    document.getElementById('modal-confirmar').style.display = 'flex';
}

function confirmarCambioSubplan(rut) {
    const subplanSelect = document.getElementById(`subplan-${rut}`);
    const subplanTexto = subplanSelect.options[subplanSelect.selectedIndex].text;
    const subplanValor = subplanSelect.value;

    if (!subplanValor) return; 

    document.getElementById('mensaje-cambio-subplan').innerText =
        `¬øConfirma que desea asignar el SubPlan: "${subplanTexto}"?`;

    document.getElementById('rut-subplan-hidden').value = rut;
    document.getElementById('nuevo-subplan-hidden-modal').value = subplanValor;

    document.getElementById("modal-cambio-subplan").style.display = 'flex';
}

function cerrarModalSubplan() {
    document.getElementById("modal-cambio-subplan").style.display = 'none';
}

function validarFormulario(event) {
    const rut = document.getElementById('rutInput').value.trim();
    const mensajeError = document.getElementById('errorMensaje');

    if (rut === "") {
        event.preventDefault();
        mensajeError.textContent = "Por favor ingrese un RUT.";
        mensajeError.style.display = "block";
        return false;
    }

    mensajeError.style.display = "none"; 
    return true;
}

function handleSelectChange(selectElement, rut) {
    selectElement.form.submit();
}

function abrirModalCliente(clienteId, nombreCompleto) {
    const form = document.getElementById('formEliminarCliente');
    form.action = `/eliminar-cliente/${clienteId}/`; 
    document.getElementById('mensaje-modal-cliente').innerText =
        `¬øEst√°s seguro que deseas eliminar a "${nombreCompleto}"?`;
    document.getElementById('modalEliminarCliente').style.display = 'flex';
}

function cerrarModalCliente() {
    document.getElementById('modalEliminarCliente').style.display = 'none';
}

function abrirModalSesion(select, rut) {
    const tipo = select.value;
    if (!tipo) return;

    document.getElementById("modal-rut").value = rut;
    document.getElementById("modal-tipo-sesion").value = tipo;

    let texto = "";
    if (tipo === "ninguno") texto = "Asignar sesi√≥n: No Asistio";
    if (tipo === "nutricional") texto = "Asignar sesi√≥n: Nutricional";
    if (tipo === "kinesiologia") texto = "Asignar sesi√≥n: Kinesiolog√≠a";

    document.getElementById("texto-modal-sesion").innerText = texto;
    document.getElementById("modal-sesion").style.display = "flex";
    document.getElementById("modal-fecha").value = "";
}

function cerrarModalSesion() {
    document.getElementById("modal-sesion").style.display = "none";
}

function guardarSesion(event) {
    event.preventDefault();

    const rut = document.getElementById("modal-rut").value;
    const tipo = document.getElementById("modal-tipo-sesion").value;
    const fecha = document.getElementById("modal-fecha").value;

    if (!fecha) {
        alert("Selecciona una fecha");
        return;
    }

    document.getElementById(`tipo-sesion-${rut}`).value = tipo;
    document.getElementById(`fecha-sesion-${rut}`).value = fecha;

    const select = document.querySelector(`#form-sesion-${rut} .select-bonito`);
    if (select) {
        select.value = tipo;
    }

    document.getElementById(`form-sesion-${rut}`).submit();
    cerrarModalSesion();
}

let rutPersonalizado = null;

function abrirModalRenovarPersonalizado(rut) {
    rutPersonalizado = rut;
    document.getElementById("mensaje-renovar-personalizado").innerText =
        `¬øDeseas renovar el plan personalizado para el cliente con RUT ${rut}?`;
    document.getElementById("modal-renovar-personalizado").style.display = 'flex';
}

function confirmarRenovacionPersonalizado() {
    if (rutPersonalizado) {
        document.getElementById(`form-renovar-personalizado-${rutPersonalizado}`).submit();
    }
}

function cerrarModalRenovarPersonalizado() {
    document.getElementById("modal-renovar-personalizado").style.display = 'none';
    rutPersonalizado = null;
}
</script>


{% endblock %}
