{% extends 'core/home.html' %}
{% load static %}

{% block content %}

<div class="centrar-buscador">
    <form method="post" class="busqueda-container" onsubmit="return validarFormulario(event)">
        {% csrf_token %}
        <div class="busqueda-fila">
            <input type="text" id="rutInput" name="rut" placeholder="Buscar Cliente por RUT" value="{{ rut_buscado }}">
            <button type="submit" class="btn-global">üîç Buscar</button>
        </div>

        {% if rut_buscado %}
            <div class="mostrar-todos">
                <a href="{% url 'renovarCliente' %}" class="btn-global">
                    üßπ Limpiar Filtro
                </a>
            </div>
        {% endif %}
        
        <div id="errorMensaje" class="error-text"></div>
    </form>
</div>

{% if messages %}
  <div id="mi-mensaje-contenedor" class="mi-mensaje-contenedor">
    {% for message in messages %}
      <div class="mi-mensaje mi-mensaje-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>

  <script>
    setTimeout(function() {
      const mensaje = document.getElementById("mi-mensaje-contenedor");
      if (mensaje) {
        mensaje.style.transition = "opacity 1s ease";
        mensaje.style.opacity = 0;
        setTimeout(() => mensaje.remove(), 8000); 
      }
    }, 8000); 
  </script>
{% endif %}

{% if clientes %}
    <table class="tabla-renovar">
        <thead>
            <tr>
                <th>Nombre Completo</th>
                <th>RUT</th>
                <th>Correo</th>
                <th>Telefono</th>
                <th>Tipo de Plan</th>
                <th>Plan Personalizado</th>
                <th>Estado De Plan</th>
                <th>Metodo de pago</th>
                <th>Renovar</th>
                <th>Modifcar Cliente </th>
                <th>Eliminar Cliente</th>
            </tr>
        </thead>
        <tbody>
            {% for cliente in clientes %}
            <tr>
                <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                <td>{{ cliente.rut }}</td>
                <td>{{ cliente.correo }}</td>
                <td>+ {{ cliente.telefono }}</td>

                <!-- Tipo de plan -->
             <td>
                <form method="post" action="{% url 'cambiar_tipo_plan_mensual' %}" id="form-plan-{{ cliente.rut }}">
                    {% csrf_token %}
                    <input type="hidden" name="rut_cliente" value="{{ cliente.rut }}">
                    <select name="nuevo_plan" onchange="handleSelectChange(this, '{{ cliente.rut }}')" class="select-bonito">
                        <option value="">-- Selecciona --</option>
                        {% for mensualidad in tipos_mensualidad %}
                            <option value="{{ mensualidad.id }}"
                                {% if cliente.mensualidad and cliente.mensualidad.id == mensualidad.id %}selected{% endif %}>
                                {{ mensualidad.tipo }} + Plan {{ mensualidad.duracion }}
                            </option>
                        {% endfor %}
                        <!--
                        <option value="agregar_meses">Agregar m√°s meses</option>
                        -->
                    </select>
                </form>
            </td>


                <!-- Plan personalizado -->
                <td>
                    <form method="post" action="{% url 'cambiar_plan_personalizado' %}">
                        {% csrf_token %}
                        <input type="hidden" name="rut_cliente" value="{{ cliente.rut }}">
                        <select name="nuevo_plan" onchange="this.form.submit()" class="select-bonito">
                            <option value="">-- Selecciona --</option>
                            {% for plan in planes_personalizados %}
                                <option value="{{ plan.id }}" {% if cliente.plan_personalizado and cliente.plan_personalizado.id == plan.id %}selected{% endif %}>
                                    {{ plan.nombre_plan }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </td>

                <!-- Estado del plan -->
             <td>
    {% if cliente.dias_restantes <= 0 %}
        <span class="inactivo">Vencido</span>
    {% else %}
        Activo ({{ cliente.dias_restantes }} d√≠as restantes)
    {% endif %}
</td>

                <td>
                    {{ cliente.metodo_pago }}
                </td>

                <td>
                   <button type="button" class="btn-global" onclick="confirmarRenovacion('{{ cliente.rut }}')">Renovar</button>
                </td>
                    <td>

                <button type="button" class="btn-global"
                    onclick="window.location.href='{% url 'modificar_cliente' cliente.id %}'">
                     Editar
                </button>
                 </td>
                <td>
                    <button type="button" class="btn-global" onclick="abrirModalCliente({{ cliente.id }}, '{{ cliente.nombre }} {{ cliente.apellido }}')">
                         Eliminar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
   <p style="text-align: center; font-size: 18px; color: black;">
        No se encontr√≥ el RUT del Cliente.
   </p>
{% endif %}

<!-- MODAL PARA ELIMINAR CLIENTE -->
<div id="modalEliminarCliente" class="modal modal-error" style="display: none;">
  <div class="modal-cliente-content">
    <button type="button" class="modal-close" onclick="cerrarModalCliente()">&times;</button>
    <h2>Eliminar cliente</h2>
    <p id="mensaje-modal-cliente">¬øEst√°s seguro que deseas eliminar a este cliente?</p>
    <form id="formEliminarCliente" method="POST">
      {% csrf_token %}
      <div class="modal-cliente-actions">
        <button type="submit" class="btn-cliente-eliminar">üóëÔ∏è S√≠, eliminar</button>
        <button type="button" onclick="cerrarModalCliente()" class="btn-cliente-cancelar">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL PARA AGREGAR MAS MESES 
<div id="modal-agregar-meses" class="modal-agregar" style="display:none;">
  <div class="modal-agregar-content">
    <button type="button" class="modal-agregar-cerrar" onclick="cerrarModalAgregar()" title="Cerrar">&times;</button>
    <h2>Agregar meses al plan</h2>
    <form method="post" action="{% url 'agregar_meses_plan' %}">
        {% csrf_token %}
        <input type="hidden" name="rut_cliente" id="modal-rut-cliente">
        <p>¬øCu√°ntos meses quieres agregar?</p>
        <input type="number" name="meses" min="1" required
               style="margin-top: 10px; padding: 8px; width: 100%; border: 1px solid #ccc; border-radius: 5px;">

        <div style="text-align: center; margin-top: 25px;">
            <button type="submit" class="btn-confirmar-agregar">‚úÖ Confirmar</button>
        </div>
    </form>
  </div>
</div>
-->
<!-- MODAL PARA ELEGIR METODO DE PAGO -->
<div id="modal-metodo-pago" class="modal-renovar" style="display: none;">
    <div class="modal-content-renovar">
        <p>Selecciona el m√©todo de pago:</p>
        <form id="form-metodo-pago" onsubmit="mostrarConfirmacion(event)">
            <input type="hidden" id="rut-metodo" name="rut">
            <select id="metodo-pago" class="select-bonito" required>
                <option value="">-- Selecciona --</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Debito">D√©bito</option>
                <option value="Credito">Cr√©dito</option>
                <option value="Transferencia">Transferencia</option>
            </select>
            <br><br>
            <button type="submit">Continuar</button>
            <button type="button" onclick="cerrarModalMetodo()">Cancelar</button>
        </form>
    </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN -->
<div id="modal-confirmar" class="modal-renovar" style="display: none;">
    <div class="modal-content-renovar">
        <p>¬øEst√°s seguro que deseas renovar el plan?</p>
        <form method="post" action="{% url 'renovarCliente' %}">
            {% csrf_token %}
            <input type="hidden" id="rut-renovar" name="renovar_rut">
            <input type="hidden" id="metodo-pago-hidden" name="metodo_pago">
            <button type="submit">S√≠, renovar</button>
            <button type="button" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
function confirmarRenovacion(rut) {
    document.getElementById('rut-metodo').value = rut;
    document.getElementById('modal-metodo-pago').style.display = 'flex';
}

function cerrarModalMetodo() {
    document.getElementById('modal-metodo-pago').style.display = 'none';
}

function mostrarConfirmacion(event) {
    event.preventDefault();
    const metodo = document.getElementById('metodo-pago').value;
    const rut = document.getElementById('rut-metodo').value;

    if (!metodo) {
        alert("Selecciona un m√©todo de pago");
        return;
    }

    
    document.getElementById('rut-renovar').value = rut;
    document.getElementById('metodo-pago-hidden').value = metodo;

   
    cerrarModalMetodo();
    document.getElementById('modal-confirmar').style.display = 'flex';
}

function cerrarModal() {
    document.getElementById('modal-confirmar').style.display = 'none';
}

function validarFormulario(event) {
    const rut = document.getElementById('rutInput').value.trim();
    const mensajeError = document.getElementById('errorMensaje');

    if (rut === "") {
        event.preventDefault();
        mensajeError.textContent = "Por favor ingrese un RUT.";
        mensajeError.style.display = "block";
        return false;
    }

    mensajeError.style.display = "none"; 
    return true;
}

function handleSelectChange(selectElement, rut) {
    if (selectElement.value === "agregar_meses") {
        document.getElementById('modal-rut-cliente').value = rut;
        document.getElementById('modal-agregar-meses').style.display = 'flex';
        selectElement.value = "";
    } else {
        selectElement.form.submit();
    }
}

function cerrarModalAgregar() {
    document.getElementById('modal-agregar-meses').style.display = 'none';
}

function abrirModalCliente(clienteId, nombreCompleto) {
    const form = document.getElementById('formEliminarCliente');
    form.action = `/eliminar-cliente/${clienteId}/`; 
    document.getElementById('mensaje-modal-cliente').innerText =
        `¬øEst√°s seguro que deseas eliminar a "${nombreCompleto}"?`;
    document.getElementById('modalEliminarCliente').style.display = 'flex';
}

function cerrarModalCliente() {
    document.getElementById('modalEliminarCliente').style.display = 'none';
}
</script>

{% endblock %}
