{% extends 'core/home.html' %}
{% load static %}

{% block content %}
<main class="contenido asistencia-page">
    <div class="asistencia-contenedor-central">
        <h1 class="asistencia-titulo-pagina">ü©∫ Asistencia Kinesiolog√≠a y Nutrici√≥n</h1>

        <div style="margin-bottom: 20px;">
            <a href="{% url 'registrar_cliente_externo' %}" class="btn-global">‚ûï Registrar Cliente Externo</a>
        </div>

        <!-- Buscador -->
        <input type="text" id="asistencia-busqueda" class="asistencia-buscador" placeholder="Buscar cliente por nombre o RUT...">

        <!-- Tabla de clientes -->
        <div class="asistencia-tabla-wrapper">
            <table class="asistencia-table table table-hover table-striped" id="asistencia-tablaClientes">
                <thead class="table-dark">
                    <tr>
                        <th>Cliente</th>
                        <th>Nutrici√≥n</th>
                        <th>Kinesiolog√≠a</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in clientes %}
                    <tr>
                        <td>
                            <strong>{{ cliente.nombre }} {{ cliente.apellido }}</strong>
                            <small style="color:#555;">({{ cliente.tipo_objeto|capfirst }})</small><br>
                            <small class="text-muted">{{ cliente.rut }}</small>
                        </td>
                        <td>
                            <button class="asistencia-btn asistencia-btn-nutri registrar"
                                data-id="{{ cliente.id }}"
                                data-nombre="{{ cliente.nombre }} {{ cliente.apellido }}"
                                data-tipo="nutricional"
                                data-tipo-objeto="{{ cliente.tipo_objeto }}">ü•ó Nutrici√≥n</button>
                        </td>
                        <td>
                            <button class="asistencia-btn asistencia-btn-kine registrar"
                                data-id="{{ cliente.id }}"
                                data-nombre="{{ cliente.nombre }} {{ cliente.apellido }}"
                                data-tipo="kinesiologia"
                                data-tipo-objeto="{{ cliente.tipo_objeto }}">üèÉ‚Äç‚ôÇÔ∏è Kinesiolog√≠a</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <hr>

        <!-- Historial -->
        <h2>üìã √öltimas asistencias</h2>
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Profesional</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody id="asistencia-historial">
                {% for sesion in sesiones %}
                <tr>
                  <td>
                    {% if sesion.cliente %}
                        {{ sesion.cliente.nombre }} {{ sesion.cliente.apellido }}
                    {% elif sesion.cliente_externo %}
                        {{ sesion.cliente_externo.nombre }} {{ sesion.cliente_externo.apellido }}
                    {% else %}
                        <em>Sin cliente</em>
                    {% endif %}
                </td>
                                    <td>{{ sesion.get_tipo_sesion_display }}</td>
                    <td>{{ sesion.profesional.nombre }} {{ sesion.profesional.apellido }}</td>
                    <td>{{ sesion.fecha|date:"d/m/Y" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">No hay asistencias registradas</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<!-- Modal -->
<div id="asistencia-modal" class="asistencia-modal">
    <div class="asistencia-modal-content">
        <span id="asistencia-close" class="asistencia-modal-close">&times;</span>
        <p id="asistencia-modal-text">¬øConfirmar asistencia?</p>

        <div id="profesional-select-container" style="display:none; margin-bottom:15px;">
            <label for="profesional-select">Seleccionar profesional:</label>
            <select id="profesional-select" class="form-select">
                <option value="">Seleccione un profesional...</option>
            </select>
        </div>

        <div class="asistencia-modal-buttons">
            <button id="asistencia-confirm" class="asistencia-btn asistencia-btn-confirm" disabled>Confirmar</button>
            <button id="asistencia-cancel" class="asistencia-btn asistencia-btn-cancel">Cancelar</button>
        </div>
    </div>
</div>

{{ nutricionistas|json_script:"nutricionistas-data" }}
{{ kinesiologos|json_script:"kinesiologos-data" }}

<script>
const csrfToken = "{{ csrf_token }}";
const nutricionistas = JSON.parse(document.getElementById('nutricionistas-data').textContent);
const kinesiologos = JSON.parse(document.getElementById('kinesiologos-data').textContent);

const modal = document.getElementById('asistencia-modal');
const modalText = document.getElementById('asistencia-modal-text');
const profesionalSelectContainer = document.getElementById('profesional-select-container');
const profesionalSelect = document.getElementById('profesional-select');
const btnClose = document.getElementById('asistencia-close');
const btnCancel = document.getElementById('asistencia-cancel');
const btnConfirm = document.getElementById('asistencia-confirm');

let clienteIdGlobal, tipoSesionGlobal, profesionalIdGlobal, tipoObjetoGlobal;


document.getElementById('asistencia-busqueda').addEventListener('input', function() {
    const filtro = this.value.trim().toLowerCase();
    document.querySelectorAll('#asistencia-tablaClientes tbody tr').forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        fila.style.display = texto.includes(filtro) ? '' : 'none';
    });
});

document.querySelectorAll('.registrar').forEach(btn => {
    btn.addEventListener('click', function() {
        clienteIdGlobal = this.dataset.id;
        tipoSesionGlobal = this.dataset.tipo;
        tipoObjetoGlobal = this.dataset.tipoObjeto;
        const nombreCliente = this.dataset.nombre;

        modalText.textContent = `¬øConfirmar asistencia de ${nombreCliente} a ${tipoSesionGlobal === 'nutricional' ? 'Nutrici√≥n' : 'Kinesiolog√≠a'}?`;

        profesionalSelect.innerHTML = '<option value="">Seleccione un profesional...</option>';
        const lista = tipoSesionGlobal === "nutricional" ? nutricionistas : kinesiologos;
        lista.forEach(p => profesionalSelect.innerHTML += `<option value="${p.id}">${p.nombre} ${p.apellido}</option>`);

        profesionalSelectContainer.style.display = 'block';
        btnConfirm.disabled = true;
        modal.style.display = 'block';
    });
});

profesionalSelect.addEventListener('change', () => {
    profesionalIdGlobal = profesionalSelect.value;
    btnConfirm.disabled = !profesionalIdGlobal;
});


btnClose.onclick = () => modal.style.display = 'none';
btnCancel.onclick = () => modal.style.display = 'none';
window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

btnConfirm.onclick = () => {
    if (!profesionalIdGlobal) return;

    const originalText = btnConfirm.textContent;
    btnConfirm.textContent = "Ingresando...";
    btnConfirm.disabled = true;

    fetch("{% url 'asistencia_kine_nutri' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
        },
        body: `cliente_id=${encodeURIComponent(clienteIdGlobal)}&tipo_sesion=${encodeURIComponent(tipoSesionGlobal)}&profesional_id=${encodeURIComponent(profesionalIdGlobal)}&tipo_objeto=${encodeURIComponent(tipoObjetoGlobal)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const fila = `<tr>
                <td>${data.cliente}</td>
                <td>${data.tipo}</td>
                <td>${data.profesional}</td>
                <td>${data.fecha}</td>
            </tr>`;
            document.querySelector('#asistencia-historial').insertAdjacentHTML('afterbegin', fila);
            modal.style.display = 'none';
        } else {
            alert("‚ö†Ô∏è Error: " + (data.error || "No se pudo registrar la asistencia."));
        }
    })
    .catch(err => {
        console.error("Error al registrar asistencia:", err);
        alert("‚ùå Error al registrar la asistencia.");
    })
    .finally(() => {
        btnConfirm.textContent = originalText;
        btnConfirm.disabled = false;
    });
};
</script>
{% endblock %}
