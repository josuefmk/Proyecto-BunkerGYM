{% extends 'core/home.html' %}
{% block content %}
<main class="contenido asistencia">
    <div class="form-container-historial"> 
        <form method="POST" class="formulario">
            {% csrf_token %}
            <h2>Registro de Asistencia</h2>
            <label for="rut">Ingrese RUT</label>
            <input type="text" name="rut" id="rut" required>
        </form>
    </div>

    {# Modal de confirmación de asistencia final #}
    {% if mostrar_modal %}
    <div class="modal-custom">
        <div class="modal-content-custom">
            <h2>✅ Registro de Asistencia</h2>
            <p>Bienvenido <strong>{{ cliente.nombre }} {{ cliente.apellido }}</strong></p>
            <p>El plan le vence el <strong>{{ vencimiento_plan|date:"d" }} de {{ vencimiento_plan|date:"F" }}</strong></p>

            {# SubPlan normal (si no es Titanio) #}
            {% if cliente.sub_plan and cliente.sub_plan != "Titanio" %}
                <p>Accesos restantes este mes: <strong>{{ cliente.accesos_restantes }}</strong></p>
            {% endif %}

            {# Plan personalizado activo #}
            {% if cliente.plan_personalizado_activo and cliente.plan_personalizado_activo.nombre_plan != "Ninguno" %}
                {% if plan_libre %}
                    <p>Acceso ilimitado este mes</p>
                    <p>Plan usado: <strong>{{ cliente.plan_personalizado_activo.nombre_plan }}</strong></p>
                {% else %}
                    <p>Accesos restantes este mes: <strong>{{ cliente.accesos_restantes }}</strong></p>
                    <p>Plan usado: <strong>{{ cliente.plan_personalizado_activo.nombre_plan }}</strong></p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if planes_personalizados and planes_personalizados|length > 1 and not mostrar_modal %}
    <div class="modal-custom">
        <div class="modal-content-custom">
            <h2>Selecciona el plan personalizado</h2>
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="rut" value="{{ cliente.rut }}">
                <input type="hidden" name="confirmar" value="1">
                <label for="plan_personalizado">Plan a usar:</label>
                <select name="plan_personalizado" id="plan_personalizado" required>
                    {% for plan in planes_personalizados %}
                        <option value="{{ plan.id }}">{{ plan.nombre_plan }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn-confirmar">Confirmar Plan</button>
            </form>
        </div>
    </div>
    {% endif %}

    {# Modales de error o alerta #}
    {% if rut_invalido %}
    <div class="modal-custom modal-error-custom">
        <div class="modal-content-custom">
            <h2 style="color:#dc3545;">❌ Error</h2>
            <p>El RUT ingresado no fue encontrado</p>
        </div>
    </div>
    {% endif %}

    {% if asistencia_ya_registrada %}
    <div class="modal-custom modal-warning-custom">
        <div class="modal-content-custom">
            <h2 style="color:#ffc107;">⚠️ Atención</h2>
            <p>El RUT ya está ingresado hoy.</p>
        </div>
    </div>
    {% endif %}

    {% if plan_vencido %}
    <div class="modal-custom modal-error-custom">
        <div class="modal-content-custom">
            <h2 style="color:#dc3545;">❌ Plan Vencido</h2>
            <p>Debe renovarlo para poder ingresar.</p>
        </div>
    </div>
    {% endif %}

    {% if sin_accesos %}
    <div class="modal-custom modal-error-custom">
        <div class="modal-content-custom">
            <h2 style="color:#dc3545;">❌ Sin Accesos</h2>
            <p>No le quedan accesos disponibles para ingresar.</p>
        </div>
    </div>
    {% endif %}

</main>

<script>
function cerrarModal() {
    document.querySelectorAll('.modal-custom').forEach(modal => modal.style.display = 'none');
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.modal-custom').forEach(modal => {
        setTimeout(() => { cerrarModal(); }, 5000);
    });
});
</script>
{% endblock %}