{% extends 'core/home.html' %}
{% block content %}
{% load myfilters %}
<main class="contenido historia-cliente">

<div class="form-container-historial"> 
    <form method="POST" class="formulario" id="form-rut">
        {% csrf_token %}
        <h2>Historial del Cliente</h2>
        <label for="rut">Ingrese RUT</label>
        <input type="text" name="rut" id="rut" value="{{ rut }}">
        <button type="submit" class="btn-global" style="margin-top: 15px;">Buscar</button>
    </form>
</div>

<div id="cliente-container">
    {% if cliente %}
        {% include 'core/cliente_info.html' %}
    {% endif %}
</div>

<div id="calendario-container">
    {% if cliente %}
        {% include 'core/calendario_parcial.html' %}
    {% endif %}
</div>

<script>
(function() {
    const calendarioContainer = document.getElementById('calendario-container');
    const rutInput = document.getElementById('rut');
    let year = {{ current_year }};
    let month = {{ current_month }};
    let asistencias = {{ asistencias_dict|safe }};

    function agregarEventos(asistencias) {
        const btnPrev = document.getElementById('prev-month');
        const btnNext = document.getElementById('next-month');
        const detallesHoras = document.getElementById('detalles-horas');

        // Navegación de meses
        if (btnPrev) {
            btnPrev.onclick = () => {
                month--;
                if (month < 1) { month = 12; year--; }
                cargarCalendario();
            };
        }

        if (btnNext) {
            btnNext.onclick = () => {
                month++;
                if (month > 12) { month = 1; year++; }
                cargarCalendario();
            };
        }

        // Asignar eventos a cada día con asistencia
        calendarioContainer.querySelectorAll('.calendar-day.has-assistance').forEach(div => {
            div.onclick = () => {
                const dia = div.getAttribute('data-day');
                const horas = asistencias[dia];
                if (horas && horas.length > 0) {
                    detallesHoras.innerHTML = `<strong>Asistencias del día ${dia}:</strong><br>` +
                        horas.map(h => `• ${h}`).join('<br>');
                } else {
                    detallesHoras.innerHTML = `<strong>No hay asistencias registradas para el día ${dia}.</strong>`;
                }
                detallesHoras.scrollIntoView({behavior: "smooth"});
            };
        });
    }

    function cargarCalendario() {
        if (!rutInput.value.trim()) {
            alert('Ingrese un RUT para consultar.');
            return;
        }

        fetch(`${window.location.pathname}?rut=${rutInput.value.trim()}&month=${month}&year=${year}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            // Actualizar HTML del cliente y calendario
            document.getElementById('cliente-container').innerHTML = data.cliente;
            calendarioContainer.innerHTML = data.calendario;

            // Actualizar asistencias desde la respuesta AJAX
            asistencias = data.asistencias;

            // Reasignar eventos
            agregarEventos(asistencias);
        })
        .catch(() => alert('Error cargando el calendario'));
    }

    // Inicializar eventos en la carga de la página
    agregarEventos(asistencias);

    // Formulario de búsqueda por RUT
    document.getElementById('form-rut').onsubmit = function(e) {
        e.preventDefault();
        year = new Date().getFullYear();
        month = new Date().getMonth() + 1;
        cargarCalendario();
    };
})();
</script>

{% if rut_invalido %}
<div class="modal modal-error">
    <div class="modal-content">
        <button onclick="this.parentElement.parentElement.style.display='none'">✖</button>
        <h2 style="color:#dc3545;">❌ Error</h2>
        <p>El RUT ingresado no fue encontrado.</p>
        <p>Por favor, verifica e intenta nuevamente.</p>
    </div>
</div>
{% endif %}

</main>
{% endblock %}
