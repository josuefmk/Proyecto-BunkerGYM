{% extends 'core/home.html' %}
{% load myfilters %}
{% block content %}

<main class="historial-wrapper">

    <!-- FORMULARIO PREMIUM -->
    <div class="historial-card">
        <h2>Historial del Cliente</h2>
        <p class="sub">Ingrese el RUT para ver su historial de asistencias y sesiones</p>

        <form method="POST" class="historial-form" id="form-rut">
            {% csrf_token %}

            <div class="input-group-historial">
                <input type="text" name="rut" id="rut" placeholder="Ej: 12345678-9">
            </div>

            <button type="submit" class="btn-historial">Buscar</button>
        </form>
    </div>

    <!-- Contenedores dinámicos -->
    <div id="cliente-container" class="cliente-premium"></div>
    <div id="calendario-container" class="calendario-premium"></div>

    <!-- MODAL DE ERROR PREMIUM -->
    <div id="modal-error" class="modal-premium" style="display:none;">
        <div class="modal-content-premium modal-error-border">
            <span class="close-modal" onclick="cerrarModal(this)">&times;</span>
            <h2 class="error-title">❌ RUT no encontrado</h2>
            <p>Por favor verifique el RUT ingresado.</p>
        </div>
    </div>

</main>

<script>
(function() {
    const form = document.getElementById('form-rut');
    let year = {{ current_year }};
    let month = {{ current_month }};
    let asistencias = {};
    let sesiones = {};

    function agregarEventos() {
        const detalles = document.getElementById('detalles-horas');
        document.querySelectorAll('.calendar-day.has-assistance, .calendar-day.has-session, .calendar-day.has-both')
            .forEach(div => {
                div.onclick = () => {
                    const dia = div.dataset.day;
                    let html = `<strong>Detalles del día ${dia}:</strong><br>`;
                    (asistencias[dia] || []).forEach(h => html += `• Ingreso: ${h}<br>`);
                    (sesiones[dia] || []).forEach(s => html += `• Sesión: ${s}<br>`);
                    if (!asistencias[dia]?.length && !sesiones[dia]?.length) html += 'No hay registros.';
                    detalles.innerHTML = html;
                };
            });
    }

    function showModalError() {
        const modal = document.getElementById("modal-error");
        modal.style.display = "flex";
        modal.style.opacity = "1";

        setTimeout(() => {
            modal.style.opacity = "0";
            setTimeout(() => { modal.style.display = "none"; }, 300);
        }, 4000);
    }

    function cargarCalendario() {
        const rut = document.getElementById('rut').value.trim();
        if (!rut) return alert('Ingrese un RUT');

        fetch(`${window.location.pathname}?rut=${rut}&month=${month}&year=${year}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('cliente-container').innerHTML = data.cliente;
            document.getElementById('calendario-container').innerHTML = data.calendario;

            asistencias = data.asistencias;
            sesiones = data.sesiones;

            if (data.rut_invalido) showModalError();
            else agregarEventos();
        });
    }

    form.onsubmit = function(e) {
        e.preventDefault();
        year = new Date().getFullYear();
        month = new Date().getMonth() + 1;
        cargarCalendario();
    };

    document.addEventListener('click', (e) => {
        if (e.target.id === 'prev-month') { month--; if (month < 1) { month = 12; year--; } cargarCalendario(); }
        if (e.target.id === 'next-month') { month++; if (month > 12) { month = 1; year++; } cargarCalendario(); }
    });

})();
</script>

{% endblock %}
