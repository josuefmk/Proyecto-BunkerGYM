{% extends 'core/home.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="contenido">

{% if messages %}
  <div id="mi-mensaje-contenedor" class="mi-mensaje-contenedor">
    {% for message in messages %}
      <div class="mi-mensaje mi-mensaje-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  <script>
    setTimeout(function() {
      const mensaje = document.getElementById("mi-mensaje-contenedor");
      if (mensaje) {
        mensaje.style.transition = "opacity 1s ease";
        mensaje.style.opacity = 0;
        setTimeout(() => mensaje.remove(), 8000);
      }
    }, 8000);
  </script>
{% endif %}

<div class="card-tabla">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 class="titulo-tabla" style=" margin-top: 10px; margin-bottom: 25px;">Registrar Venta</h2>
  </div>

  <form method="POST" action="{% url 'registrar_venta' %}" id="form-venta">
    {% csrf_token %}
    <label for="producto">Producto:</label>
    <select name="producto_id" class="select-bonito" required>
      <option value="" disabled {% if not producto_seleccionado %}selected{% endif %}>
        -- Seleccione Un Producto --
      </option>
      {% for producto in productos %}
      <option value="{{ producto.id }}"
        {% if producto.id == producto_seleccionado %}selected{% endif %}>
        {{ producto.nombre }} ‚Äî Stock: {{ producto.stock }} ‚Äî
        ${{ producto.precio_venta|floatformat:0|intcomma }} CLP
      </option>
      {% endfor %}
    </select>
    <div class="campo-cantidad">
      <label for="cantidad" class="etiqueta-cantidad">Cantidad a vender:</label>
      <input type="number" name="cantidad" id="cantidad" min="1" class="input-bonito" required>
    </div>
      <div class="campo-metodo">
      <label for="metodo_pago">M√©todo de Pago:</label>
      <select name="metodo_pago" id="metodo_pago" class="select-bonito" required>
      <option value="" disabled selected>-- Seleccione un m√©todo --</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Debito">D√©bito</option>
      <option value="Credito">Cr√©dito</option>
      <option value="Transferencia">Transferencia</option>
      </select>
      </div>

    <br>
    <button type="submit" class="btn-global" id="btn-venta">üí∞ Registrar Venta</button>
  </form>
</div>

<div class="card-tabla">
 <div style="display: flex; justify-content: space-between; align-items: center;">
  <h2 class="titulo-tabla" style="margin: 0;">Productos Disponibles</h2>
  <div style="display: flex; gap: 10px;">
    <a href="{% url 'agregar_producto' %}" class="btn-global">‚ûï Agregar Producto</a>
    <a href="{% url 'agregar_stock' %}" class="btn-global">üì¶ Agregar Stock</a>
    <a href="{% url 'historial_ventas' %}" class="btn-global">üìú Historial de Ventas</a>
  </div>
</div>


  <div class="tabla-wrapper" style="margin-top: 15px;">
 <table class="tabla-clientes">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Descripci√≥n</th>
      <th>Compra</th>
      <th>Venta</th>
      <th>Stock Inicial</th>
      <th>Stock Actual</th>
      <th>Vendidos</th>
      <th>Valor Base</th>
      <th>Ganancia Estimada</th>
      <th>Ganancia Real</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for producto in productos %}
    <tr {% if producto.id == producto_seleccionado %}style="background: #f0f8ff;"{% endif %}>
      <td>{{ producto.nombre }}</td>
      <td>{{ producto.descripcion }}</td>
      <td>CLP ${{ producto.precio_compra|floatformat:0|intcomma }}</td>
      <td>CLP ${{ producto.precio_venta|floatformat:0|intcomma }}</td>
      <td>{{ producto.stock_inicial }}</td>
      <td>{{ producto.stock }}</td>
      <td>{{ producto.cantidad_vendida }}</td>
      <td>CLP ${{ producto.valor_total_stock|floatformat:0|intcomma }}</td>
      <td>CLP ${{ producto.estimado_ganancia|floatformat:0|intcomma }}</td>
      <td>CLP ${{ producto.ganancia_real|floatformat:0|intcomma }}</td>
      <td>
        <a href="{% url 'editar_producto' producto.id %}" class="btn-accion editar">‚úèÔ∏è</a>
        <button type="button" class="btn-accion eliminar"
                onclick="mostrarModal({{ producto.id }}, '{{ producto.nombre }}')">üóëÔ∏è</button>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="11" class="mensaje-centrado">No hay productos registrados.</td></tr>
    {% endfor %}
  </tbody>
</table>
  </div>
</div>

<div id="modalEliminar" class="modal modal-error" style="display: none;">
  <div class="modal-producto-content">
    <button type="button" class="modal-close" onclick="cerrarModal()">&times;</button>
    <h2>Eliminar producto</h2>
    <p id="mensaje-modal"></p>
    <form id="formEliminar" method="POST">
      {% csrf_token %}
      <div class="modal-producto-actions">
        <button type="submit" class="btn-producto-eliminar">S√≠, eliminar</button>
        <button type="button" onclick="cerrarModal()" class="btn-producto-cancelar">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Bloqueo de doble submit en registrar venta
  const formVenta = document.getElementById('form-venta');
  const btnVenta = document.getElementById('btn-venta');

  formVenta.addEventListener('submit', function() {
    btnVenta.disabled = true;
  });

  // Modal de eliminar producto
  function mostrarModal(productoId, productoNombre) {
    const modal = document.getElementById("modalEliminar");
    const mensaje = document.getElementById("mensaje-modal");
    const form = document.getElementById("formEliminar");

    mensaje.innerHTML = `¬øEst√°s seguro de que deseas eliminar el producto <strong>"${productoNombre}"</strong>?`;
    form.action = "{% url 'eliminar_producto' 0 %}".replace('0', productoId);
    modal.style.display = "flex";
  }

  function cerrarModal() {
    document.getElementById("modalEliminar").style.display = "none";
  }
</script>

</div>
{% endblock %}
