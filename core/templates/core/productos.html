{% extends 'core/home.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<div class="productos-wrapper">

  
    {% if messages %}
    <div id="mensaje-bunker" class="mensaje-bunker">
        {% for message in messages %}
        <div class="msg msg-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>

    <script>
        setTimeout(() => {
            const box = document.getElementById("mensaje-bunker");
            if (box) {
                box.style.opacity = "0";
                setTimeout(() => box.remove(), 800);
            }
        }, 4000);
    </script>
    {% endif %}

    <!-- CARD REGISTRAR VENTA -->
    <div class="card-premium-v2">

        <div class="card-header">
            <h2>Registrar Venta</h2>
        </div>

        <form method="POST" action="{% url 'registrar_venta' %}" id="form-venta">
            {% csrf_token %}

            <label>Producto:</label>
            <select name="producto_id" class="select-premium" required>
                <option value="" disabled selected>‚Äî Seleccione un Producto ‚Äî</option>
                {% for producto in productos %}
                <option value="{{ producto.id }}"
                        {% if producto.id == producto_seleccionado %}selected{% endif %}>
                    {{ producto.nombre }} ‚Äî Stock: {{ producto.stock }} ‚Äî 
                    ${{ producto.precio_venta|floatformat:0|intcomma }} CLP
                </option>
                {% endfor %}
            </select>

            <label>Cantidad:</label>
            <input type="number" name="cantidad" min="1" class="input-premium" required>

            <label>M√©todo de pago:</label>
            <select name="metodo_pago" class="select-premium" required>
                <option value="" disabled selected>‚Äî Seleccione un m√©todo ‚Äî</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Debito">D√©bito</option>
                <option value="Credito">Cr√©dito</option>
                <option value="Transferencia">Transferencia</option>
            </select>

            <button class="btn-premium-full">üí∞ Registrar Venta</button>
        </form>
    </div>

    <!-- TABLA DE PRODUCTOS -->
    <div class="card-premium-v2">

        <div class="card-header-flex">
            <h2>Productos Disponibles</h2>

            <div class="btn-group-flex">
                <a href="{% url 'agregar_producto' %}" class="btn-premium">‚ûï Agregar</a>
                <a href="{% url 'agregar_stock' %}" class="btn-premium">üì¶ Stock</a>
                <a href="{% url 'historial_ventas' %}" class="btn-premium">üìú Ventas</a>
            </div>
          
        </div>
   <br>
        <div class="tabla-scroll">
        <table class="tabla-premium">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Descripci√≥n</th>
                    <th>Compra</th>
                    <th>Venta</th>
                    {% if request.user_obj.rut == "18449809K" or request.user_obj.rut == "178569554" %}
                    <th>Stock Inicial</th>
                    <th>Vendidos</th>
                    {% endif %}
                    <th>Stock</th>
                    <th>Valor Base</th>
                    <th>Ganancia Estimada</th>
                    <th>Ganancia Real</th>
                    <th class="acciones-col">Acciones</th>
                </tr>
            </thead>

            <tbody>
                {% for producto in productos %}
                <tr {% if producto.id == producto_seleccionado %}class="fila-activa"{% endif %}>
                    <td>{{ producto.nombre }}</td>
                    <td>{{ producto.descripcion }}</td>
                    <td>${{ producto.precio_compra|floatformat:0|intcomma }}</td>
                    <td>${{ producto.precio_venta|floatformat:0|intcomma }}</td>

                    {% if request.user_obj.rut == "18449809K" or request.user_obj.rut == "178569554" %}
                    <td>{{ producto.stock_inicial }}</td>
                    <td>{{ producto.cantidad_vendida }}</td>
                    {% endif %}

                    <td>{{ producto.stock }}</td>
                    <td>${{ producto.valor_total_stock|floatformat:0|intcomma }}</td>
                    <td>${{ producto.estimado_ganancia|floatformat:0|intcomma }}</td>
                    <td>${{ producto.ganancia_real|floatformat:0|intcomma }}</td>

                    <td class="acciones">
                        <a href="{% url 'editar_producto' producto.id %}" class="btn-mini editar">‚úèÔ∏è</a>
                        <button onclick="mostrarModal({{ producto.id }}, '{{ producto.nombre }}')" 
                                class="btn-mini eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="no-data">No hay productos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- MODAL ELIMINAR -->
    <div id="modalEliminar" class="modal-premium" style="display:none;">
        <div class="modal-content-premium modal-error-border">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>

            <h2>Eliminar Producto</h2>
            <p id="mensaje-modal"></p>

            <form id="formEliminar" method="POST">
                {% csrf_token %}
                <button class="btn-modal-danger">S√≠, eliminar</button>
                <button type="button" onclick="cerrarModal()" class="btn-modal-cancel">Cancelar</button>
            </form>
        </div>
    </div>

</div>

<script>
function mostrarModal(id, nombre) {
    const modal = document.getElementById("modalEliminar");
    modal.style.display = "flex";

    document.getElementById("mensaje-modal").innerHTML =
        `¬øEliminar <strong>${nombre}</strong>?`;

    document.getElementById("formEliminar").action =
        "{% url 'eliminar_producto' 0 %}".replace("0", id);
}

function cerrarModal() {
    document.getElementById("modalEliminar").style.display = "none";
}

document.getElementById("form-venta")?.addEventListener("submit", () => {
    document.querySelector(".btn-premium-full").disabled = true;
});
</script>

{% endblock %}
