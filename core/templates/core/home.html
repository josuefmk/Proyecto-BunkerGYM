{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>BunkerGYM</title>
    <link rel="shortcut icon" href="{% static 'core/img/BunkerIMG.jpg' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/styles.css' %}">
</head>
<body>
<header class="header">
    <img src="{% static 'core/img/BunkerIMG.jpg' %}" alt="Logo Bunker Gym" class="logo">

    {% if request.session.admin_id %}
    <div class="header-right">

        {# MENSAJE DE BIENVENIDA SOLO EN INDEX #}
        {% if request.resolver_match.view_name == 'index' %}
            <span class="welcome-message">
                Bienvenido, {{ username }}!
            </span>
        {% endif %}

        <div class="header-buttons">

            {# BOT√ìN VOLVER SOLO PARA ADMIN EN TODAS LAS VISTAS MENOS INDEX Y HOME #}
            {% if request.session.admin_profesion == 'Administrador' %}
                {% if request.resolver_match.view_name != 'index' and request.resolver_match.view_name != 'home' %}
                    <button class="btn-global" onclick="location.href='{% url 'index' %}'">
                        <img src="{% static 'core/img/volver.png' %}" class="icon"> Volver
                    </button>
                {% endif %}
            {% endif %}

            {# BOT√ìN CERRAR SESI√ìN #}
            <button class="btn-global" onclick="location.href='{% url 'logout' %}'">
                <img src="{% static 'core/img/logout.png' %}" class="icon"> Cerrar Sesi√≥n
            </button>

        </div>
    </div>
    {% endif %}
</header>





{% if not request.session.admin_id %}
<main class="form-container">
    <form method="post" class='formulario' id="login-form">
        {% csrf_token %}
        <h2>Inicio Sesi√≥n</h2>
        <input type="text" id="rut" name="rut" placeholder="RUT (sin puntos ni guion)" maxlength="12">
        <input type="password" name="password" placeholder="Contrase√±a">
        <button type="submit" class="btn-global" style="margin-top: 15px;">üîê Ingresar</button>
        
        {% if error %}
        <div class="alerta-error">
            ‚ö†Ô∏è {{ error }}
        </div>
        {% endif %}
        <div id="rut-error" style="color:red; font-size: 14px; margin-top: 5px; display:none;">
            ‚ùå RUT inv√°lido
        </div>
    </form>
</main>
{% endif %}

{% block content %}{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const inputRut = document.getElementById("rut");
const rutError = document.getElementById("rut-error");
const form = document.getElementById("login-form");


function validarRut(rut) {
    rut = rut.replace(/[^0-9kK]/gi, "").toUpperCase();
    if (rut.length < 2) return false;

    let cuerpo = rut.slice(0, -1);
    let dv = rut.slice(-1);

    let suma = 0;
    let multiplo = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo[i]) * multiplo;
        multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }

    let dvEsperado = 11 - (suma % 11);
    let dvFinal = dvEsperado === 11 ? "0" : dvEsperado === 10 ? "K" : dvEsperado.toString();

    return dvFinal === dv;
}

function formatearRut(valor) {
    valor = valor.replace(/[^0-9kK]/gi, "").toUpperCase();
    if (valor.length < 2) return valor;

    let cuerpo = valor.slice(0, -1);
    let dv = valor.slice(-1);

    let cuerpoFormateado = "";
    let contador = 0;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        cuerpoFormateado = cuerpo[i] + cuerpoFormateado;
        contador++;
        if (contador === 3 && i !== 0) {
            cuerpoFormateado = "." + cuerpoFormateado;
            contador = 0;
        }
    }
    return cuerpoFormateado + "-" + dv;
}

inputRut.addEventListener("blur", function() {
    if (inputRut.value && !validarRut(inputRut.value)) {
        rutError.style.display = "block";
        inputRut.style.border = "2px solid red";
    } else {
        rutError.style.display = "none";
        if (inputRut.value) {
            inputRut.value = formatearRut(inputRut.value);
        }
        inputRut.style.border = "";
    }
});


form.addEventListener("submit", function(e) {
    if (!validarRut(inputRut.value)) {
        e.preventDefault();
        rutError.style.display = "block";
        inputRut.style.border = "2px solid red";
    }
});
</script>
</body>
</html>
